<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PurgeBot</title>
<link rel="icon" type="image/png" href="/favicon.png">
<script src="vendor/tailwind.js"></script>
<script defer src="vendor/alpine-collapse.js"></script>
<script defer src="vendor/alpine.js"></script>
<script src="vendor/cronstrue.js"></script>
<script src="vendor/chart.js"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          gh: {
            bg: '#0d1117', card: '#161b22', border: '#21262d',
            border2: '#30363d', text: '#e1e4e8', muted: '#8b949e',
            dim: '#484f58', blue: '#58a6ff', green: '#3fb950',
            red: '#f85149', yellow: '#d29922', purple: '#bc8cff',
          }
        }
      }
    }
  }
</script>
<style>
  [x-cloak] { display: none !important; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  .log-mono { font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; }
  @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  .pulse-dot { animation: pulse-dot 2s infinite; }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #0d1117; }
  ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #484f58; }
</style>
</head>
<body class="bg-gh-bg text-gh-text min-h-screen" x-data="app()" x-init="init()">

<!-- Header -->
<header class="bg-gh-card border-b border-gh-border px-6 py-4 flex items-center justify-between flex-wrap gap-3">
  <div class="flex items-center gap-3">
    <h1 class="text-xl font-semibold">PurgeBot</h1>
    <span class="text-xs text-gh-dim" x-text="status.guildName || 'Connecting...'"></span>
  </div>
  <div class="flex items-center gap-3">
    <!-- Connection status -->
    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border"
      :class="status.connected
        ? 'bg-green-900/30 text-gh-green border-green-800'
        : 'bg-red-900/30 text-gh-red border-red-800'">
      <span class="w-2 h-2 rounded-full" :class="status.connected ? 'bg-gh-green pulse-dot' : 'bg-gh-red'"></span>
      <span x-text="status.connected ? 'Connected' : 'Disconnected'"></span>
    </span>
    <!-- Schedule disabled badge (uses editConfig for immediate feedback, syncs on save/discard) -->
    <span x-show="editConfig.scheduleEnabled === false" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gh-border text-gh-dim border border-gh-border2">
      <span class="w-2 h-2 rounded-full bg-gh-dim"></span> Schedule Off
    </span>
    <!-- Dry run badge -->
    <span x-show="status.dryRun" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-900/30 text-gh-yellow border border-yellow-800">
      <span class="w-2 h-2 rounded-full bg-gh-yellow"></span> Dry Run
    </span>
    <!-- Running badge -->
    <span x-show="status.cleanupRunning" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-blue-900/30 text-gh-blue border border-blue-800">
      <span class="w-2 h-2 rounded-full bg-gh-blue pulse-dot"></span> Running
    </span>
  </div>
</header>

<!-- Tabs + Action buttons -->
<nav class="flex items-center gap-0 px-6 bg-gh-bg border-b border-gh-border">
  <template x-for="t in visibleTabs" :key="t.id">
    <button @click="tab = t.id" class="px-5 py-2.5 text-sm font-medium border-b-2 transition flex items-center gap-1.5"
      :class="tab === t.id ? 'text-gh-text border-gh-blue' : 'text-gh-muted border-transparent hover:text-gh-text'">
      <span x-text="t.label"></span>
      <span x-show="t.badge" x-text="t.badge" class="bg-gh-border2 text-gh-muted text-[10px] px-1.5 py-0.5 rounded-full"></span>
    </button>
  </template>
</nav>

<!-- Global unsaved changes banner -->
<div x-show="configDirty" x-cloak class="px-6 pt-4">
  <div class="flex items-center justify-between bg-yellow-900/20 border border-yellow-800 rounded-lg px-4 py-2">
    <span class="text-sm text-gh-yellow">You have unsaved changes</span>
    <div class="flex gap-2">
      <button @click="loadConfig()" class="text-xs px-3 py-1 rounded border border-gh-border2 bg-gh-border text-gh-text hover:border-gh-blue">Discard</button>
      <button @click="saveConfig()" class="text-xs px-3 py-1 rounded bg-green-600 border border-green-600 text-white hover:bg-green-500">Save</button>
    </div>
  </div>
</div>

<!-- ===== OVERVIEW TAB ===== -->
<div x-show="tab === 'overview'" x-cloak class="p-6">
  <!-- Stat cards -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
    <div @click="showCategoryList = !showCategoryList" class="bg-gh-card border border-gh-border rounded-lg p-4 cursor-pointer hover:border-gh-blue transition">
      <div class="text-[11px] text-gh-muted uppercase tracking-wider flex items-center justify-between">
        Categories
        <svg class="w-3 h-3 text-gh-dim transition-transform" :class="showCategoryList && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
      <div class="text-3xl font-semibold text-gh-blue mt-1" x-text="status.totalCategories || 0"></div>
      <div class="text-[11px] text-gh-dim mt-0.5" x-text="(status.enabledCategories || 0) + ' enabled, ' + ((status.totalCategories || 0) - (status.enabledCategories || 0)) + ' disabled'"></div>
    </div>
    <div class="bg-gh-card border border-gh-border rounded-lg p-4">
      <div class="text-[11px] text-gh-muted uppercase tracking-wider">Last Run Deleted</div>
      <div class="text-3xl font-semibold text-gh-green mt-1" x-text="stats.lastLiveRun ? stats.lastLiveRun.totalPurged.toLocaleString() : '—'"></div>
      <div class="text-[11px] text-gh-dim mt-0.5" x-text="stats.lastLiveRun ? 'Live run · ' + formatDuration(stats.lastLiveRun.duration) : 'No live runs yet'"></div>
    </div>
    <div class="bg-gh-card border border-gh-border rounded-lg p-4">
      <div class="text-[11px] text-gh-muted uppercase tracking-wider">Errors</div>
      <div class="text-3xl font-semibold mt-1" :class="(stats.lastLiveRun?.totalErrors || 0) > 0 ? 'text-gh-red' : 'text-gh-green'" x-text="stats.lastLiveRun ? stats.lastLiveRun.totalErrors : '—'"></div>
      <div class="text-[11px] text-gh-dim mt-0.5" x-text="stats.lastLiveRun ? 'Last live run' : 'No live runs yet'"></div>
    </div>
    <div class="bg-gh-card border border-gh-border rounded-lg p-4">
      <div class="text-[11px] text-gh-muted uppercase tracking-wider">Next Cleanup</div>
      <div class="text-xl font-semibold text-gh-yellow mt-1" x-text="nextRunDisplay"></div>
      <div class="text-[11px] text-gh-dim mt-0.5" x-text="status.schedule + ' (' + status.timezone + ')'"></div>
    </div>
  </div>

  <!-- Category Manager -->
  <div x-show="showCategoryList" x-collapse class="mb-5">
    <template x-for="[catName, cat] in Object.entries(editConfig.categories || {}).sort((a,b) => a[0].localeCompare(b[0]))" :key="catName">
      <div class="bg-gh-card border border-gh-border rounded-lg mb-2 overflow-hidden">
        <!-- Category header -->
        <div @click="toggleCategory(catName)" class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gh-bg/50 transition">
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full" :class="cat.enabled ? 'bg-gh-green' : 'bg-gh-dim'"></span>
            <span class="text-sm font-medium" x-text="catName"></span>
            <span class="text-xs text-gh-dim" x-text="(cat._channels || []).length + ' ch'"></span>
          </div>
          <div class="flex items-center gap-3 text-xs text-gh-muted">
            <span>Default: <strong x-text="retentionLabel(cat.default ?? editConfig.globalDefault)"></strong></span>
            <span x-text="countOverrides(cat) + ' override' + (countOverrides(cat) !== 1 ? 's' : '')"></span>
            <span :class="cat.enabled ? 'text-gh-green' : 'text-gh-dim'" x-text="cat.enabled ? 'Enabled' : 'Disabled'"></span>
            <button x-show="cat.enabled" @click.stop="runCategory(catName)" :disabled="status.cleanupRunning || syncRunning"
              class="px-2 py-0.5 rounded border border-gh-border2 bg-gh-bg text-gh-muted hover:text-gh-blue hover:border-gh-blue transition disabled:opacity-50 disabled:cursor-not-allowed"
              x-text="status.dryRun ? 'Dry Run' : 'Run'"></button>
            <svg class="w-4 h-4 transition-transform" :class="openCategories.includes(catName) && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </div>
        </div>
        <!-- Category body -->
        <div x-show="openCategories.includes(catName)" x-collapse class="border-t border-gh-border px-4 pb-3">
          <!-- Category controls -->
          <div class="flex items-center gap-4 py-3 border-b border-gh-border">
            <div class="flex items-center gap-2">
              <span class="text-xs text-gh-muted">Enabled:</span>
              <button @click="cat.enabled = !cat.enabled; configDirty = true"
                class="w-8 h-4 rounded-full relative transition-colors"
                :class="cat.enabled ? 'bg-blue-600' : 'bg-gh-border2'">
                <span class="absolute w-3 h-3 bg-white rounded-full top-0.5 transition-all"
                  :class="cat.enabled ? 'left-[18px]' : 'left-0.5'"></span>
              </button>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gh-muted">Default retention:</span>
              <input type="number" :value="cat.default ?? ''" @input="setCategoryDefault(catName, $event.target.value)" class="px-2 py-0.5 rounded border border-gh-border2 bg-gh-bg text-gh-text text-xs w-14 text-center focus:border-gh-blue outline-none" min="-1" placeholder="global">
              <span class="text-xs text-gh-dim">days</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gh-muted">Delete old (&gt;14d):</span>
              <button @click="if (cat.deleteOld === false) { delete cat.deleteOld; } else { cat.deleteOld = false; } configDirty = true"
                class="w-8 h-4 rounded-full relative transition-colors"
                :class="cat.deleteOld !== false ? 'bg-blue-600' : 'bg-gh-border2'">
                <span class="absolute w-3 h-3 bg-white rounded-full top-0.5 transition-all"
                  :class="cat.deleteOld !== false ? 'left-[18px]' : 'left-0.5'"></span>
              </button>
            </div>
          </div>
          <!-- Channel list -->
          <template x-for="(ch, idx) in (cat._channels || [])" :key="idx">
            <div class="flex items-center justify-between py-1.5 text-sm">
              <span class="text-gh-muted flex items-center gap-1">
                <span class="text-gh-dim">#</span>
                <span x-text="channelName(ch)"></span>
              </span>
              <div class="flex items-center gap-2">
                <span class="text-[10px] px-1.5 py-0.5 rounded"
                  :class="channelRetentionClass(ch, cat)">
                  <span x-text="channelRetentionLabel(ch, cat)"></span>
                </span>
                <input type="number" :value="channelOverride(ch)" @input="setChannelOverride(catName, idx, $event.target.value)"
                  class="px-1.5 py-0.5 rounded border border-gh-border2 bg-gh-bg text-gh-text text-xs w-12 text-center focus:border-gh-blue outline-none"
                  min="-1" placeholder="—">
                <button x-show="cat.enabled && channelEffectiveRetention(ch, cat) !== -1" @click.stop="runChannel(catName, channelName(ch))" :disabled="status.cleanupRunning || syncRunning"
                  class="text-[10px] px-2 py-0.5 rounded border border-gh-border2 bg-gh-bg text-gh-muted hover:text-gh-blue hover:border-gh-blue transition disabled:opacity-50 disabled:cursor-not-allowed"
                  x-text="status.dryRun ? 'Dry Run' : 'Run'"></button>
              </div>
            </div>
          </template>
          <div x-show="!cat._channels || cat._channels.length === 0" class="text-xs text-gh-dim py-2">No channels — run Sync first</div>
          <!-- Running indicator -->
          <div x-show="categoryRunning[catName]" class="mt-3 pt-3 border-t border-gh-border text-xs text-gh-blue flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-gh-blue pulse-dot"></span> Running...
          </div>
          <!-- Run results -->
          <template x-if="categoryResults[catName]">
            <div class="mt-3 pt-3 border-t border-gh-border">
              <div class="flex flex-wrap gap-4 mb-2 text-xs">
                <span class="text-gh-muted">Channels: <strong class="text-gh-blue" x-text="categoryResults[catName].processed"></strong></span>
                <span class="text-gh-muted"><span x-text="categoryResults[catName].dryRun ? 'Would delete' : 'Deleted'"></span>: <strong class="text-gh-red" x-text="categoryResults[catName].purged"></strong></span>
                <span class="text-gh-muted">Errors: <strong :class="categoryResults[catName].errors > 0 ? 'text-gh-red' : 'text-gh-green'" x-text="categoryResults[catName].errors"></strong></span>
                <span class="text-gh-dim" x-text="categoryResults[catName].dryRun ? 'dry-run' : 'live'"></span>
              </div>
              <template x-for="ch in categoryResults[catName].channels" :key="ch.name">
                <div class="flex items-center justify-between py-1 text-xs border-b border-gh-bg last:border-b-0">
                  <span class="text-gh-muted"><span class="text-gh-dim">#</span><span x-text="ch.name"></span></span>
                  <span class="font-semibold"
                    :class="ch.skipped ? 'text-gh-dim' : (ch.purged > 0 ? 'text-gh-red' : 'text-gh-green')"
                    x-text="ch.skipped ? 'skipped (never delete)' : (ch.purged > 0 ? ch.purged + ' messages' : '0 (all within retention)')"></span>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>

  <!-- Two columns -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <!-- Top channels -->
    <div class="bg-gh-card border border-gh-border rounded-lg p-4">
      <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-3">Top Channels (Last Run)</h3>
      <template x-if="stats.lastRun">
        <div>
          <template x-for="ch in topChannels" :key="ch.category + '/' + ch.name">
            <div class="flex justify-between items-center py-1.5 border-b border-gh-border last:border-b-0 text-sm">
              <div>
                <span class="text-gh-text" x-text="'#' + ch.name"></span>
                <span class="text-gh-dim text-xs ml-1" x-text="ch.category"></span>
              </div>
              <span class="text-gh-blue font-semibold text-sm" x-text="ch.purged + ' deleted'"></span>
            </div>
          </template>
          <div x-show="topChannels.length === 0" class="text-sm text-gh-dim">No messages deleted</div>
        </div>
      </template>
      <div x-show="!stats.lastRun" class="text-sm text-gh-dim">No stats yet — run a cleanup first</div>
    </div>

    <!-- Run history -->
    <div class="bg-gh-card border border-gh-border rounded-lg p-4">
      <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-3">Run History</h3>
      <template x-for="(run, idx) in (stats.history || []).slice(0, 8)" :key="run.timestamp">
        <div class="border-b border-gh-border last:border-b-0">
          <div @click="historyExpanded = historyExpanded === idx ? null : idx" class="flex justify-between items-center py-1.5 text-sm cursor-pointer hover:bg-gh-bg/50 transition px-1 rounded">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full" :class="run.errors > 0 ? 'bg-gh-red' : (run.dryRun ? 'bg-gh-blue' : 'bg-gh-green')"></span>
              <span class="text-gh-text text-xs" x-text="formatDate(run.timestamp)"></span>
            </div>
            <div class="flex items-center gap-2 text-xs">
              <span class="px-1.5 py-0.5 rounded border"
                :class="run.dryRun ? 'text-gh-blue border-blue-800 bg-blue-900/20' : (run.trigger === 'schedule' ? 'text-gh-purple border-purple-800 bg-purple-900/20' : 'text-gh-green border-green-800 bg-green-900/20')"
                x-text="run.dryRun ? 'dry-run' : (run.trigger === 'schedule' ? 'scheduled' : 'live')"></span>
              <span class="font-semibold" :class="run.purged > 0 ? 'text-gh-red' : 'text-gh-muted'" x-text="run.purged + ' purged'"></span>
              <span class="text-gh-dim" x-text="formatDuration(run.duration)"></span>
              <svg class="w-3 h-3 text-gh-dim transition-transform" :class="historyExpanded === idx && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </div>
          </div>
          <!-- Expanded category breakdown -->
          <div x-show="historyExpanded === idx" x-collapse class="px-1 pb-2">
            <template x-for="[catName, catData] in Object.entries(run.categories || {}).sort((a,b) => a[0].localeCompare(b[0]))" :key="catName">
              <div class="flex items-center justify-between py-0.5 text-xs pl-4">
                <span class="text-gh-muted" x-text="catName"></span>
                <div class="flex items-center gap-2">
                  <span :class="catData.purged > 0 ? (run.dryRun ? 'text-gh-blue' : 'text-gh-green') : 'text-gh-dim'" x-text="catData.purged > 0 ? catData.purged + ' purged' : 'clean'"></span>
                  <span x-show="catData.errors > 0" class="text-gh-red" x-text="catData.errors + ' error' + (catData.errors > 1 ? 's' : '')"></span>
                </div>
              </div>
            </template>
            <div x-show="!run.categories || Object.keys(run.categories).length === 0" class="text-xs text-gh-dim pl-4 py-1">No category data</div>
          </div>
        </div>
      </template>
      <div x-show="!stats.history || stats.history.length === 0" class="text-sm text-gh-dim">No history yet</div>
    </div>
  </div>
</div>

<!-- ===== CONFIGURATION TAB ===== -->
<div x-show="tab === 'config'" x-cloak class="p-6 space-y-4">

  <!-- Schedule Section -->
  <div class="bg-gh-card border border-gh-border rounded-lg overflow-hidden">
    <button @click="configSections.schedule = !configSections.schedule" class="w-full flex items-center justify-between px-5 py-3 hover:bg-gh-bg/50 transition cursor-pointer">
      <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider">Schedule</h3>
      <svg class="w-4 h-4 text-gh-dim transition-transform duration-200" :class="configSections.schedule && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>
    <div x-show="configSections.schedule" x-collapse>
      <div class="px-5 pb-4 border-t border-gh-border">
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Enabled</div><div class="text-xs text-gh-dim">Run cleanup automatically on schedule</div></div>
          <button @click="editConfig.scheduleEnabled = !editConfig.scheduleEnabled; configDirty = true"
            class="w-10 h-5 rounded-full relative transition-colors"
            :class="editConfig.scheduleEnabled ? 'bg-blue-600' : 'bg-gh-border2'">
            <span class="absolute w-4 h-4 bg-white rounded-full top-0.5 transition-all"
              :class="editConfig.scheduleEnabled ? 'left-5' : 'left-0.5'"></span>
          </button>
        </div>
        <div x-show="!editConfig.scheduleEnabled" class="pb-1">
          <div class="text-xs text-gh-yellow bg-yellow-900/20 border border-yellow-800/50 rounded px-3 py-2">
            Schedule is paused — cleanup only runs manually from the Cleanup tab.
          </div>
        </div>
        <div x-show="editConfig.scheduleEnabled" class="pb-1">
          <div class="text-xs text-gh-muted bg-gh-bg border border-gh-border rounded px-3 py-2">
            <span x-text="cronHuman"></span> — edit on the <button @click="tab = 'schedule'" class="text-gh-blue hover:underline">Schedule tab</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cleanup Section -->
  <div class="bg-gh-card border border-gh-border rounded-lg overflow-hidden">
    <button @click="configSections.cleanup = !configSections.cleanup" class="w-full flex items-center justify-between px-5 py-3 hover:bg-gh-bg/50 transition cursor-pointer">
      <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider">Cleanup</h3>
      <svg class="w-4 h-4 text-gh-dim transition-transform duration-200" :class="configSections.cleanup && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>
    <div x-show="configSections.cleanup" x-collapse>
      <div class="px-5 pb-4 space-y-0 divide-y divide-gh-border border-t border-gh-border">
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Dry Run</div><div class="text-xs text-gh-dim">Log what would be deleted without deleting</div></div>
          <button @click="editConfig.dryRun = !editConfig.dryRun; configDirty = true"
            class="w-10 h-5 rounded-full relative transition-colors"
            :class="editConfig.dryRun ? 'bg-blue-600' : 'bg-gh-border2'">
            <span class="absolute w-4 h-4 bg-white rounded-full top-0.5 transition-all"
              :class="editConfig.dryRun ? 'left-5' : 'left-0.5'"></span>
          </button>
        </div>
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Global Default Retention</div><div class="text-xs text-gh-dim">Delete messages older than this many days. Use -1 to never delete, 0 to delete all</div></div>
          <div class="flex items-center gap-2">
            <input type="number" x-model.number="editConfig.globalDefault" @input="configDirty = true" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm w-20 text-right focus:border-gh-blue outline-none" min="-1">
            <span class="text-xs text-gh-dim">days</span>
          </div>
        </div>
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Skip Pinned Messages</div><div class="text-xs text-gh-dim">Never delete pinned messages</div></div>
          <button @click="editConfig.discord.skipPinned = !editConfig.discord.skipPinned; configDirty = true"
            class="w-10 h-5 rounded-full relative transition-colors"
            :class="editConfig.discord.skipPinned ? 'bg-blue-600' : 'bg-gh-border2'">
            <span class="absolute w-4 h-4 bg-white rounded-full top-0.5 transition-all"
              :class="editConfig.discord.skipPinned ? 'left-5' : 'left-0.5'"></span>
          </button>
        </div>
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Max Messages Per Channel</div><div class="text-xs text-gh-dim">How many messages to scan per channel each run</div></div>
          <input type="number" x-model.number="editConfig.discord.maxMessagesPerChannel" @input="configDirty = true" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm w-20 text-right focus:border-gh-blue outline-none" min="1">
        </div>
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Max Old Deletes Per Channel</div><div class="text-xs text-gh-dim">Messages older than 14 days are deleted individually (slow). Set to 0 to skip</div></div>
          <input type="number" x-model.number="editConfig.discord.maxOldDeletesPerChannel" @input="configDirty = true" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm w-20 text-right focus:border-gh-blue outline-none" min="0">
        </div>
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Delay Between Channels</div><div class="text-xs text-gh-dim">Pause between processing each channel to avoid rate limits</div></div>
          <div class="flex items-center gap-2">
            <input type="number" x-model.number="editConfig.discord.delayBetweenChannels" @input="configDirty = true" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm w-24 text-right focus:border-gh-blue outline-none" min="0">
            <span class="text-xs text-gh-dim">ms</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Discord Notifications Section -->
  <div class="bg-gh-card border border-gh-border rounded-lg overflow-hidden">
    <button @click="configSections.discord = !configSections.discord" class="w-full flex items-center justify-between px-5 py-3 hover:bg-gh-bg/50 transition cursor-pointer">
      <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider">Discord Notifications</h3>
      <svg class="w-4 h-4 text-gh-dim transition-transform duration-200" :class="configSections.discord && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>
    <div x-show="configSections.discord" x-collapse>
      <div class="px-5 pb-4 space-y-0 divide-y divide-gh-border border-t border-gh-border">
        <div class="py-3">
          <div class="flex items-center justify-between gap-4 mb-2">
            <div class="shrink-0"><div class="text-sm">Cleanup Webhook</div><div class="text-xs text-gh-dim">Cleanup summary embeds after each run</div></div>
            <button @click="testWebhook('cleanup')" :disabled="!editConfig.webhooks?.cleanup || webhookTesting === 'cleanup'"
              class="shrink-0 px-3 py-1.5 rounded-md border text-xs transition disabled:opacity-40 disabled:cursor-not-allowed"
              :class="webhookTesting === 'cleanup' ? 'border-gh-border2 text-gh-dim' : 'border-gh-border2 text-gh-muted hover:text-gh-text hover:border-gh-blue'"
              x-text="webhookTesting === 'cleanup' ? 'Sending...' : 'Test'"></button>
          </div>
          <input x-model="editConfig.webhooks.cleanup" @input="configDirty = true" placeholder="https://discord.com/api/webhooks/..." class="w-full px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm font-mono focus:border-gh-blue outline-none">
          <div class="flex items-center gap-2 mt-2">
            <span class="text-xs text-gh-dim">Embed color</span>
            <span class="w-5 h-5 rounded border border-gh-border2 shrink-0" :style="'background:' + (editConfig.webhooks?.cleanupColor || '#238636')"></span>
            <input x-model="editConfig.webhooks.cleanupColor" @input="configDirty = true" class="px-2 py-1 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-xs w-24 font-mono focus:border-gh-blue outline-none" placeholder="#238636">
          </div>
        </div>
        <div class="py-3">
          <div class="flex items-center justify-between gap-4 mb-2">
            <div class="shrink-0"><div class="text-sm">Info Webhook</div><div class="text-xs text-gh-dim">Auto-discovery notifications (new channels found)</div></div>
            <button @click="testWebhook('info')" :disabled="!editConfig.webhooks?.info || webhookTesting === 'info'"
              class="shrink-0 px-3 py-1.5 rounded-md border text-xs transition disabled:opacity-40 disabled:cursor-not-allowed"
              :class="webhookTesting === 'info' ? 'border-gh-border2 text-gh-dim' : 'border-gh-border2 text-gh-muted hover:text-gh-text hover:border-gh-blue'"
              x-text="webhookTesting === 'info' ? 'Sending...' : 'Test'"></button>
          </div>
          <input x-model="editConfig.webhooks.info" @input="configDirty = true" placeholder="https://discord.com/api/webhooks/..." class="w-full px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm font-mono focus:border-gh-blue outline-none">
          <div class="flex items-center gap-2 mt-2">
            <span class="text-xs text-gh-dim">Embed color</span>
            <span class="w-5 h-5 rounded border border-gh-border2 shrink-0" :style="'background:' + (editConfig.webhooks?.infoColor || '#f39c12')"></span>
            <input x-model="editConfig.webhooks.infoColor" @input="configDirty = true" class="px-2 py-1 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-xs w-24 font-mono focus:border-gh-blue outline-none" placeholder="#f39c12">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Display & Maintenance Section -->
  <div class="bg-gh-card border border-gh-border rounded-lg overflow-hidden">
    <button @click="configSections.display = !configSections.display" class="w-full flex items-center justify-between px-5 py-3 hover:bg-gh-bg/50 transition cursor-pointer">
      <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider">Display & Maintenance</h3>
      <svg class="w-4 h-4 text-gh-dim transition-transform duration-200" :class="configSections.display && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </button>
    <div x-show="configSections.display" x-collapse>
      <div class="px-5 pb-4 space-y-0 divide-y divide-gh-border border-t border-gh-border">
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Time Format</div><div class="text-xs text-gh-dim">How timestamps are displayed in the UI</div></div>
          <select x-model="editConfig.display.timeFormat" @change="configDirty = true" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm focus:border-gh-blue outline-none">
            <option value="24h">24-hour (14:30)</option>
            <option value="12h">12-hour (2:30 PM)</option>
          </select>
        </div>
        <div class="flex items-center justify-between py-3">
          <div><div class="text-sm">Log Retention</div><div class="text-xs text-gh-dim">Days to keep log files</div></div>
          <div class="flex items-center gap-2">
            <input type="number" x-model.number="editConfig.logging.maxDays" @input="configDirty = true" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm w-20 text-right focus:border-gh-blue outline-none" min="1">
            <span class="text-xs text-gh-dim">days</span>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ===== SCHEDULE TAB ===== -->
<div x-show="tab === 'schedule'" x-cloak class="p-6">
  <div class="bg-gh-card border border-gh-border rounded-lg p-5 mb-4">
    <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-3">Schedule</h3>
    <div class="flex items-center gap-4 flex-wrap">
      <div class="flex items-center gap-2">
        <span class="text-xs text-gh-muted">Cron:</span>
        <input x-model="scheduleEdit.schedule" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-blue text-sm font-mono w-40 focus:border-gh-blue outline-none">
      </div>
      <span class="text-gh-dim">&rarr;</span>
      <span class="text-sm text-gh-muted" x-text="scheduleHumanPreview"></span>
      <div class="flex items-center gap-2 ml-4">
        <span class="text-xs text-gh-muted">Timezone:</span>
        <input x-model="scheduleEdit.timezone" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm w-36 focus:border-gh-blue outline-none">
      </div>
      <button x-show="scheduleEdit.schedule !== status.schedule || scheduleEdit.timezone !== status.timezone"
        @click="saveSchedule()"
        class="px-3 py-1.5 rounded-md bg-green-600 text-white text-xs hover:bg-green-500 transition ml-2">Save</button>
    </div>
  </div>

  <div class="bg-gh-card border border-gh-border rounded-lg p-5">
    <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-3">Enabled Categories</h3>
    <div class="space-y-1">
      <template x-for="[catName, cat] in Object.entries(editConfig.categories || {}).filter(([,c]) => c.enabled).sort((a,b) => a[0].localeCompare(b[0]))" :key="catName">
        <div class="flex items-center gap-3 py-1.5 border-b border-gh-border last:border-b-0">
          <span class="text-sm font-medium text-gh-text min-w-[120px]" x-text="catName"></span>
          <div class="flex-1 h-6 rounded bg-blue-900/30 border border-blue-800/50 flex items-center px-3 text-xs text-gh-blue">
            <span x-text="(cat._channels || []).length + ' channels · default: ' + retentionLabel(cat.default ?? editConfig.globalDefault)"></span>
          </div>
        </div>
      </template>
    </div>
    <div class="mt-3 text-xs text-gh-dim" x-text="'Total: ' + status.totalChannels + ' channels across ' + status.enabledCategories + ' categories · Delay: ' + (editConfig.discord?.delayBetweenChannels || 2000) + 'ms between channels'"></div>
  </div>
</div>

<!-- ===== LOGS TAB ===== -->
<div x-show="tab === 'logs'" x-cloak class="p-6">
  <!-- Toolbar -->
  <div class="flex items-center gap-2 mb-3 flex-wrap">
    <template x-for="lvl in ['All', 'INFO', 'WARN', 'ERROR']" :key="lvl">
      <button @click="logFilter = lvl" class="px-3 py-1 rounded-md border text-xs font-medium transition"
        :class="logFilter === lvl ? 'bg-blue-600 border-blue-600 text-white' : 'border-gh-border2 bg-gh-border text-gh-text hover:border-gh-blue'">
        <span x-text="lvl"></span>
      </button>
    </template>
    <input type="text" x-model="logSearch" placeholder="Search logs..." class="flex-1 max-w-[250px] px-3 py-1 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-xs outline-none focus:border-gh-blue">
    <select x-model="logDate" @change="loadLogs()" class="px-2 py-1 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-xs outline-none">
      <option value="">Today</option>
      <template x-for="f in logFiles" :key="f">
        <option :value="f.replace('purgebot-','').replace('.log','')" x-text="f.replace('purgebot-','').replace('.log','')"></option>
      </template>
    </select>
    <div class="flex items-center gap-1.5 ml-auto text-xs" :class="sseConnected ? 'text-gh-green' : 'text-gh-dim'">
      <span class="w-1.5 h-1.5 rounded-full" :class="sseConnected ? 'bg-gh-green pulse-dot' : 'bg-gh-dim'"></span>
      <span x-text="sseConnected ? 'Live' : 'Disconnected'"></span>
    </div>
  </div>

  <!-- Log container -->
  <div x-ref="logContainer" class="bg-gh-bg border border-gh-border rounded-lg p-3 log-mono text-xs leading-relaxed max-h-[500px] overflow-y-auto">
    <template x-for="(line, i) in filteredLogs" :key="i">
      <div class="flex gap-2 py-px">
        <template x-if="line.timestamp">
          <span class="text-gh-dim min-w-[170px] shrink-0" x-text="'[' + line.timestamp + ']'"></span>
        </template>
        <template x-if="line.level">
          <span class="min-w-[50px] shrink-0 font-semibold"
            :class="{'text-gh-blue': line.level === 'INFO', 'text-gh-yellow': line.level === 'WARN', 'text-gh-red': line.level === 'ERROR'}"
            x-text="line.level"></span>
        </template>
        <span class="text-gh-text" x-text="line.message || line"></span>
      </div>
    </template>
    <div x-show="filteredLogs.length === 0" class="text-gh-dim py-4 text-center">No log entries</div>
  </div>
</div>

<!-- ===== STATISTICS TAB ===== -->
<div x-show="tab === 'statistics'" x-cloak class="p-6">

  <!-- Empty state -->
  <div x-show="!stats.history || stats.history.length === 0" class="text-center py-16">
    <div class="text-gh-dim text-sm">No cleanup data yet — run a cleanup to see statistics</div>
  </div>

  <div x-show="stats.history && stats.history.length > 0">
    <!-- Summary Cards -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
        <div class="bg-gh-card border border-gh-border rounded-lg p-4">
          <div class="text-[11px] text-gh-muted uppercase tracking-wider">Total Deleted</div>
          <div class="text-2xl font-semibold mt-1 text-gh-text" x-text="(stats.lifetime?.totalPurged || 0).toLocaleString()"></div>
          <div class="text-xs text-gh-dim mt-1" x-text="stats.lifetime?.firstRun ? 'since ' + new Date(stats.lifetime.firstRun).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) : 'no live runs yet'"></div>
        </div>
        <div class="bg-gh-card border border-gh-border rounded-lg p-4">
          <div class="text-[11px] text-gh-muted uppercase tracking-wider">Avg Per Run</div>
          <div class="text-2xl font-semibold mt-1 text-gh-text" x-text="stats.lifetime?.totalRuns ? Math.round(stats.lifetime.totalPurged / stats.lifetime.totalRuns).toLocaleString() : '—'"></div>
          <div class="text-xs text-gh-dim mt-1" x-text="stats.lifetime?.totalRuns ? 'across ' + stats.lifetime.totalRuns + ' runs' : 'no live runs yet'"></div>
        </div>
        <div class="bg-gh-card border border-gh-border rounded-lg p-4">
          <div class="text-[11px] text-gh-muted uppercase tracking-wider">Highest Run</div>
          <div class="text-2xl font-semibold mt-1 text-gh-text" x-text="statsHighestRun.purged ? statsHighestRun.purged.toLocaleString() : '—'"></div>
          <div class="text-xs text-gh-dim mt-1" x-text="statsHighestRun.date || 'no live runs yet'"></div>
        </div>
        <div class="bg-gh-card border border-gh-border rounded-lg p-4">
          <div class="text-[11px] text-gh-muted uppercase tracking-wider">Error Rate</div>
          <div class="text-2xl font-semibold mt-1" :class="statsErrorRate > 1 ? 'text-gh-red' : 'text-gh-green'" x-text="stats.lifetime?.totalRuns ? statsErrorRate.toFixed(2) : '—'"></div>
          <div class="text-xs text-gh-dim mt-1">errors per run</div>
        </div>
      </div>

      <!-- Messages Deleted Over Time -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-5 mb-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider">Messages Deleted Over Time</h3>
          <span class="text-[10px] text-gh-dim">Dry-run excluded</span>
        </div>
        <div style="height: 280px;">
          <canvas id="timelineChart"></canvas>
        </div>
      </div>

      <!-- Shared toggle for breakdown row -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider">Breakdown</h3>
        <div class="flex rounded-md border border-gh-border2 overflow-hidden">
          <button @click="statsView = 'lastRun'; updateBreakdownCharts()"
            class="px-3 py-1 text-xs transition"
            :class="statsView === 'lastRun' ? 'bg-gh-border2 text-gh-text' : 'bg-gh-card text-gh-dim hover:text-gh-muted'">
            Last Run
          </button>
          <button @click="statsView = 'allTime'; updateBreakdownCharts()"
            class="px-3 py-1 text-xs transition border-l border-gh-border2"
            :class="statsView === 'allTime' ? 'bg-gh-border2 text-gh-text' : 'bg-gh-card text-gh-dim hover:text-gh-muted'">
            All Time
          </button>
        </div>
      </div>

      <!-- Two equal columns -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div class="bg-gh-card border border-gh-border rounded-lg p-5">
          <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-4">Category Breakdown</h3>
          <div style="height: 280px;" class="flex items-center justify-center relative">
            <canvas id="categoryChart"></canvas>
            <div x-show="statsBreakdownEmpty" class="absolute inset-0 flex items-center justify-center text-sm text-gh-dim">No deletion data for this view</div>
          </div>
        </div>
        <div class="bg-gh-card border border-gh-border rounded-lg p-5">
          <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-4">Top Channels</h3>
          <div style="height: 280px;" class="relative">
            <canvas id="topChannelsChart"></canvas>
            <div x-show="statsBreakdownEmpty" class="absolute inset-0 flex items-center justify-center text-sm text-gh-dim">No deletion data for this view</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- ===== CLEANUP TAB ===== -->
<div x-show="tab === 'cleanup'" x-cloak class="p-6">
  <!-- Controls -->
  <div class="flex items-center gap-3 mb-4 flex-wrap">
    <select x-model="cleanupCategory" class="px-3 py-1.5 rounded-md border border-gh-border2 bg-gh-bg text-gh-text text-sm outline-none">
      <option value="">All Categories</option>
      <template x-for="catName in Object.keys(editConfig.categories || {}).filter(c => editConfig.categories[c].enabled).sort()" :key="catName">
        <option :value="catName" x-text="catName"></option>
      </template>
    </select>
    <!-- Mode toggle -->
    <div class="flex rounded-md border border-gh-border2 overflow-hidden">
      <button @click="cleanupMode = 'dryrun'"
        class="px-3 py-1.5 text-xs font-medium transition"
        :class="cleanupMode === 'dryrun' ? 'bg-blue-600 text-white' : 'bg-gh-card text-gh-dim hover:text-gh-muted'">
        Dry Run
      </button>
      <button @click="cleanupMode = 'live'"
        class="px-3 py-1.5 text-xs font-medium transition border-l border-gh-border2"
        :class="cleanupMode === 'live' ? 'bg-green-600 text-white' : 'bg-gh-card text-gh-dim hover:text-gh-muted'">
        Live
      </button>
    </div>
    <button x-show="!cleanupRunning" @click="runCleanup()" :disabled="status.cleanupRunning || syncRunning"
      class="px-4 py-1.5 rounded-md text-white text-sm transition disabled:opacity-50 disabled:cursor-not-allowed"
      :class="cleanupMode === 'live' ? 'bg-green-600 hover:bg-green-500' : 'bg-blue-600 hover:bg-blue-500'"
      x-text="cleanupMode === 'live' ? 'Run Cleanup' : 'Run Dry-Run'">
    </button>
    <button x-show="cleanupRunning" @click="cancelCleanup()" :disabled="cleanupCancelling"
      class="px-4 py-1.5 rounded-md text-white text-sm transition bg-red-600 hover:bg-red-500 disabled:opacity-50 disabled:cursor-not-allowed">
      <span x-show="!cleanupCancelling">Cancel</span>
      <span x-show="cleanupCancelling">Cancelling...</span>
    </button>
    <span x-show="cleanupLastRun" class="text-xs text-gh-dim" x-text="'Last run: ' + formatDate(cleanupLastRun)"></span>
    <span x-show="cleanupMode === 'live' && !status.dryRun && !cleanupRunning" class="text-xs text-gh-yellow">Messages will be permanently deleted</span>
  </div>

  <!-- Running indicator -->
  <div x-show="cleanupRunning" class="bg-gh-card border border-gh-border rounded-lg p-4 mb-4 flex items-center gap-3">
    <svg class="animate-spin h-5 w-5" :class="cleanupCancelling ? 'text-gh-red' : 'text-gh-blue'" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
    <span x-show="!cleanupCancelling" class="text-sm text-gh-muted" x-text="(cleanupMode === 'live' ? 'Cleanup' : 'Dry-run') + ' running... check Live Logs for progress'"></span>
    <span x-show="cleanupCancelling" class="text-sm text-gh-red">Cancelling... finishing current channel</span>
  </div>

  <!-- Cleanup summary (clickable to expand/collapse details) -->
  <div x-show="cleanupResults" class="bg-gh-card border border-gh-border rounded-lg mb-4 overflow-hidden">
    <div @click="cleanupExpanded = !cleanupExpanded" class="p-4 flex flex-wrap gap-6 cursor-pointer hover:bg-gh-bg/50 transition items-center">
      <div><div class="text-xs text-gh-muted">Channels Scanned</div><div class="text-lg font-semibold text-gh-blue mt-0.5" x-text="cleanupResults?.totalProcessed || 0"></div></div>
      <div><div class="text-xs text-gh-muted" x-text="cleanupResults?.dryRun ? 'Would Delete' : 'Deleted'"></div><div class="text-lg font-semibold mt-0.5" :class="cleanupResults?.dryRun ? 'text-gh-blue' : 'text-gh-green'" x-text="cleanupResults?.totalPurged || 0"></div></div>
      <div><div class="text-xs text-gh-muted">Errors</div><div class="text-lg font-semibold mt-0.5" :class="(cleanupResults?.totalErrors || 0) > 0 ? 'text-gh-red' : 'text-gh-muted'" x-text="cleanupResults?.totalErrors || 0"></div></div>
      <div><div class="text-xs text-gh-muted">Duration</div><div class="text-lg font-semibold text-gh-yellow mt-0.5" x-text="formatDuration(cleanupResults?.duration)"></div></div>
      <div x-show="cleanupResults?.dryRun" class="flex items-center"><span class="text-xs text-gh-yellow bg-yellow-900/30 px-2 py-0.5 rounded border border-yellow-800">dry-run</span></div>
      <div x-show="cleanupResults?.cancelled" class="flex items-center"><span class="text-xs text-gh-red bg-red-900/30 px-2 py-0.5 rounded border border-red-800">cancelled</span></div>
      <div class="ml-auto flex items-center gap-2">
        <span class="text-xs text-gh-dim" x-text="cleanupResults?.timestamp ? formatDate(cleanupResults.timestamp) : ''"></span>
        <svg class="w-4 h-4 text-gh-dim transition-transform" :class="cleanupExpanded && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </div>
    </div>

    <!-- Cleanup results per category (collapsible) -->
    <div x-show="cleanupExpanded" x-collapse class="border-t border-gh-border p-4 pt-2 space-y-2">
      <template x-for="[catName, catData] in Object.entries(cleanupResults?.categories || {}).sort((a,b) => a[0].localeCompare(b[0]))" :key="catName">
        <div class="bg-gh-bg rounded-lg p-3">
          <div class="text-sm font-semibold mb-2 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full" :class="catData.errors > 0 ? 'bg-gh-red' : 'bg-gh-green'"></span>
            <span x-text="catName"></span>
            <span class="text-xs font-normal"
              :class="catData.purged > 0 ? (cleanupResults.dryRun ? 'text-gh-blue' : 'text-gh-green') : 'text-gh-muted'"
              x-text="catData.purged > 0 ? catData.purged + (cleanupResults.dryRun ? ' to delete' : ' deleted') : 'nothing to delete'"></span>
          </div>
          <template x-for="ch in catData.channels" :key="ch.name">
            <div class="flex items-center justify-between py-1 text-xs border-b border-gh-border last:border-b-0">
              <span class="text-gh-muted"><span class="text-gh-dim">#</span><span x-text="ch.name"></span></span>
              <span class="font-semibold"
                :class="ch.skipped ? 'text-gh-dim' : (ch.purged > 0 ? (cleanupResults.dryRun ? 'text-gh-blue' : 'text-gh-green') : 'text-gh-green')"
                x-text="ch.skipped ? 'skipped (never delete)' : (ch.purged > 0 ? ch.purged + ' messages' : '0 (all within retention)')"></span>
            </div>
          </template>
        </div>
      </template>
    </div>
  </div>

  <div x-show="!cleanupResults && !cleanupRunning" class="text-sm text-gh-dim text-center py-8">Select a mode and click run to see cleanup results</div>
</div>

<!-- ===== SYNC TAB ===== -->
<div x-show="tab === 'sync'" x-cloak class="p-6">
  <div class="bg-gh-card border border-gh-border rounded-lg p-5">
    <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-2">Channel Discovery</h3>
    <p class="text-sm text-gh-muted mb-4">Discover new Discord categories and channels. Existing config and overrides are preserved — only new items are added.</p>
    <button @click="syncChannels()" :disabled="status.cleanupRunning || syncRunning || cleanupRunning"
      class="px-4 py-1.5 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
      <span x-show="!syncRunning">Sync Channels</span>
      <span x-show="syncRunning" class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-white pulse-dot"></span> Syncing...</span>
    </button>
  </div>

  <!-- Sync results -->
  <template x-if="syncResults">
    <div class="bg-gh-card border border-gh-border rounded-lg p-5 mt-4">
      <h3 class="text-xs font-semibold text-gh-muted uppercase tracking-wider mb-3">Sync Results</h3>
      <div class="flex flex-wrap gap-6">
        <div><div class="text-xs text-gh-muted">Categories Found</div><div class="text-lg font-semibold text-gh-blue mt-0.5" x-text="syncResults.categories || 0"></div></div>
        <div><div class="text-xs text-gh-muted">Channels Found</div><div class="text-lg font-semibold text-gh-blue mt-0.5" x-text="syncResults.channels || 0"></div></div>
        <div><div class="text-xs text-gh-muted">Changes</div>
          <div class="text-lg font-semibold mt-0.5" :class="(syncResults.changes || 0) > 0 ? 'text-gh-green' : 'text-gh-muted'" x-text="syncResults.changes || 0"></div>
        </div>
      </div>
      <div x-show="(syncResults.changes || 0) === 0" class="mt-3 text-xs text-gh-dim">No changes — config is up to date</div>
      <!-- Change details -->
      <template x-if="syncResults.details && syncResults.details.length > 0">
        <div class="mt-4 pt-3 border-t border-gh-border">
          <template x-for="(detail, i) in syncResults.details" :key="i">
            <div class="flex items-start gap-2 py-1.5 text-xs border-b border-gh-bg last:border-b-0">
              <span class="shrink-0 w-4 text-center font-semibold"
                :class="detail.type === 'added' ? 'text-gh-green' : (detail.type === 'removed' ? 'text-gh-red' : 'text-gh-yellow')"
                x-text="detail.type === 'added' ? '+' : (detail.type === 'removed' ? '−' : '~')"></span>
              <div>
                <span class="text-gh-text font-medium" x-text="detail.category"></span>
                <span class="text-gh-dim" x-text="detail.scope === 'category' ? ' (category)' : ''"></span>
                <template x-if="detail.channels && detail.channels.length > 0">
                  <span class="text-gh-muted">
                    <span x-text="detail.scope === 'category' ? ' — ' : ' '"></span>
                    <span x-text="detail.channels.map(c => '#' + c).join(', ')"></span>
                  </span>
                </template>
              </div>
            </div>
          </template>
        </div>
      </template>
    </div>
  </template>
</div>

<!-- Toast notifications -->
<div x-show="toast" x-transition class="fixed bottom-6 right-6 px-4 py-2 rounded-lg text-sm font-medium shadow-lg z-50"
  :class="toastType === 'error' ? 'bg-red-900 text-gh-red border border-red-800' : 'bg-green-900 text-gh-green border border-green-800'"
  x-text="toast"></div>

<script>
// Chart.js theme (set once, shared by all chart instances)
const chartPalette = ['#58a6ff','#3fb950','#d29922','#bc8cff','#f85149','#39d353','#79c0ff','#d2a8ff','#ffa657','#ff7b72'];
const chartTooltip = { backgroundColor: '#161b22', borderColor: '#30363d', borderWidth: 1, titleColor: '#e1e4e8', bodyColor: '#8b949e', padding: 10 };
if (typeof Chart !== 'undefined') {
  Chart.defaults.color = '#8b949e';
  Chart.defaults.borderColor = '#21262d';
}

function app() {
  return {
    tab: 'overview',
    tabs: [
      { id: 'overview', label: 'Overview' },
      { id: 'cleanup', label: 'Cleanup' },
      { id: 'sync', label: 'Sync' },
      { id: 'statistics', label: 'Statistics' },
      { id: 'config', label: 'Configuration' },
      { id: 'schedule', label: 'Schedule' },
      { id: 'logs', label: 'Logs', badge: 'Live' },
    ],

    // State
    status: { connected: false, dryRun: false, schedule: '0 2 * * *', timezone: 'Europe/Oslo', totalCategories: 0, enabledCategories: 0, totalChannels: 0 },
    stats: { lastRun: null, history: [] },
    editConfig: { categories: {}, discord: {}, logging: {}, webhooks: {}, display: {}, scheduleEnabled: true },
    configDirty: false,
    configSections: { schedule: false, cleanup: false, discord: false, display: false },
    webhookTesting: null,
    openCategories: [],
    syncRunning: false,
    syncResults: null,
    showCategoryList: false,
    categoryRunning: {},
    categoryResults: {},
    scheduleEdit: { schedule: '', timezone: '' },

    // Cleanup tab
    cleanupCategory: '',
    cleanupResults: null,
    cleanupRunning: false,
    cleanupCancelling: false,
    cleanupLastRun: '',
    cleanupMode: 'dryrun',
    cleanupExpanded: true,
    historyExpanded: null,

    // Logs
    logLines: [],
    logFilter: 'All',
    logSearch: '',
    logDate: '',
    logFiles: [],
    sseSource: null,
    sseConnected: false,

    // Statistics
    statsView: 'lastRun',

    // Toast
    toast: '',
    toastType: 'success',
    toastTimer: null,

    async init() {
      await Promise.all([this.loadStatus(), this.loadStats(), this.loadConfig()]);
      // Show last run results in Cleanup tab (survives page refresh)
      if (this.stats.lastRun) this.cleanupResults = this.stats.lastRun;
      this.scheduleEdit = { schedule: this.status.schedule || '0 2 * * *', timezone: this.status.timezone || 'Europe/Oslo' };
      this.connectSSE();
      this.loadLogs();
      // Poll status every 10s
      setInterval(() => this.loadStatus(), 10000);
      // Poll stats every 30s, update charts if on statistics tab
      setInterval(() => {
        this.loadStats().then(() => {
          if (this.tab === 'statistics') this.updateStatsCharts();
        });
      }, 30000);
      // Switch away from schedule tab if schedule gets disabled
      this.$watch('editConfig.scheduleEnabled', (enabled) => {
        if (!enabled && this.tab === 'schedule') this.tab = 'config';
      });
      // Chart lifecycle: init when switching to statistics, destroy when leaving
      this.$watch('tab', (newTab, oldTab) => {
        if (oldTab === 'statistics') this.destroyStatsCharts();
        if (newTab === 'statistics') this.$nextTick(() => this.initStatsCharts());
      });
    },

    // --- API helpers ---
    // CSRF header required for state-changing requests
    apiHeaders() {
      return { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
    },

    // --- API calls ---
    async loadStatus() {
      try {
        const r = await fetch('/api/stats/status');
        if (r.ok) this.status = await r.json();
      } catch {}
    },
    async loadStats() {
      try {
        const r = await fetch('/api/stats');
        if (r.ok) this.stats = await r.json();
      } catch {}
    },
    async loadConfig() {
      try {
        const r = await fetch('/api/config');
        if (r.ok) {
          const cfg = await r.json();
          cfg.discord = cfg.discord || {};
          cfg.logging = cfg.logging || {};
          cfg.webhooks = cfg.webhooks || {};
          cfg.webhooks.cleanupColor = cfg.webhooks.cleanupColor || '#238636';
          cfg.webhooks.infoColor = cfg.webhooks.infoColor || '#f39c12';
          cfg.scheduleEnabled = cfg.scheduleEnabled !== false;
          cfg.display = cfg.display || {};
          cfg.display.timeFormat = cfg.display.timeFormat || '24h';
          this.editConfig = cfg;
          this.configDirty = false;
        }
      } catch {}
    },
    async saveConfig() {
      try {
        const r = await fetch('/api/config', {
          method: 'PUT',
          headers: this.apiHeaders(),
          body: JSON.stringify(this.editConfig),
        });
        if (r.ok) {
          this.configDirty = false;
          this.showToast('Configuration saved');
          await this.loadStatus();
          // Sync schedule editor if schedule or timezone changed
          this.scheduleEdit.schedule = this.editConfig.schedule || '0 2 * * *';
          this.scheduleEdit.timezone = this.editConfig.timezone || 'Europe/Oslo';
        } else {
          const data = await r.json();
          this.showToast(data.error || 'Save failed', 'error');
        }
      } catch (err) {
        this.showToast('Save failed: ' + err.message, 'error');
      }
    },
    async testWebhook(type) {
      const url = this.editConfig.webhooks?.[type];
      if (!url) return;
      this.webhookTesting = type;
      try {
        const r = await fetch('/api/config/test-webhook', {
          method: 'POST',
          headers: this.apiHeaders(),
          body: JSON.stringify({ type, url }),
        });
        const data = await r.json();
        if (r.ok) {
          this.showToast(`Test message sent to ${type} webhook`);
        } else {
          this.showToast(data.error || 'Webhook test failed', 'error');
        }
      } catch (err) {
        this.showToast('Webhook test failed: ' + err.message, 'error');
      } finally {
        this.webhookTesting = null;
      }
    },
    async runCleanup() {
      this.cleanupRunning = true;
      try {
        const endpoint = this.cleanupMode === 'live' ? '/api/cleanup/run' : '/api/cleanup/dryrun';
        const body = this.cleanupCategory ? { category: this.cleanupCategory } : {};
        const r = await fetch(endpoint, {
          method: 'POST',
          headers: this.apiHeaders(),
          body: JSON.stringify(body),
        });
        if (r.ok) {
          this.cleanupResults = null;
          const label = this.cleanupMode === 'live' ? 'Cleanup' : 'Dry-run';
          this.showToast(`${label} started`);
          // Results arrive via SSE cleanup-complete event — no polling needed
        } else {
          const data = await r.json();
          this.showToast(data.error || 'Failed', 'error');
          this.cleanupRunning = false;
        }
      } catch (err) {
        this.showToast('Failed: ' + err.message, 'error');
        this.cleanupRunning = false;
      }
    },
    async cancelCleanup() {
      this.cleanupCancelling = true;
      try {
        const r = await fetch('/api/cleanup/cancel', { method: 'POST', headers: this.apiHeaders() });
        if (r.ok) {
          this.showToast('Cancelling cleanup...');
        } else {
          const data = await r.json();
          this.showToast(data.error || 'Cancel failed', 'error');
          this.cleanupCancelling = false;
        }
      } catch (err) {
        this.showToast('Cancel failed: ' + err.message, 'error');
        this.cleanupCancelling = false;
      }
    },
    async syncChannels() {
      this.syncRunning = true;
      try {
        const r = await fetch('/api/cleanup/sync', { method: 'POST', headers: this.apiHeaders() });
        const data = await r.json();
        if (r.ok) {
          this.syncResults = data;
          const msg = data.changes > 0
            ? `Sync complete: ${data.categories} categories, ${data.channels} channels (${data.changes} changes)`
            : `Sync complete: ${data.categories} categories, ${data.channels} channels — no changes`;
          this.showToast(msg);
          await this.loadConfig();
          await this.loadStatus();
        } else {
          this.showToast(data.error || 'Sync failed', 'error');
        }
      } catch (err) {
        this.showToast('Sync failed: ' + err.message, 'error');
      } finally {
        this.syncRunning = false;
      }
    },
    async runCategory(catName) {
      try {
        const endpoint = this.status.dryRun ? '/api/cleanup/dryrun' : '/api/cleanup/run';
        const r = await fetch(endpoint, {
          method: 'POST',
          headers: this.apiHeaders(),
          body: JSON.stringify({ category: catName }),
        });
        const data = await r.json();
        if (r.ok) {
          // Clear previous results, set running
          const cleared = { ...this.categoryResults }; delete cleared[catName]; this.categoryResults = cleared;
          this.categoryRunning = { ...this.categoryRunning, [catName]: true };
          if (!this.openCategories.includes(catName)) this.openCategories.push(catName);
          this.showToast(`${this.status.dryRun ? 'Dry-run' : 'Cleanup'} started for ${catName}`);
        } else {
          this.showToast(data.error || 'Failed', 'error');
        }
      } catch (err) {
        this.showToast('Failed: ' + err.message, 'error');
      }
    },
    async runChannel(catName, chName) {
      try {
        const endpoint = this.status.dryRun ? '/api/cleanup/dryrun' : '/api/cleanup/run';
        const r = await fetch(endpoint, {
          method: 'POST',
          headers: this.apiHeaders(),
          body: JSON.stringify({ category: catName, channel: chName }),
        });
        const data = await r.json();
        if (r.ok) {
          const cleared = { ...this.categoryResults }; delete cleared[catName]; this.categoryResults = cleared;
          this.categoryRunning = { ...this.categoryRunning, [catName]: true };
          if (!this.openCategories.includes(catName)) this.openCategories.push(catName);
          this.showToast(`${this.status.dryRun ? 'Dry-run' : 'Cleanup'} started for #${chName}`);
        } else {
          this.showToast(data.error || 'Failed', 'error');
        }
      } catch (err) {
        this.showToast('Failed: ' + err.message, 'error');
      }
    },
    // Per-category/channel run results now arrive via SSE cleanup-complete event
    async saveSchedule() {
      try {
        const r = await fetch('/api/config/global', {
          method: 'PATCH',
          headers: this.apiHeaders(),
          body: JSON.stringify({ schedule: this.scheduleEdit.schedule, timezone: this.scheduleEdit.timezone }),
        });
        if (r.ok) {
          this.showToast('Schedule saved');
          await this.loadStatus();
          // Also sync editConfig so Configuration tab stays consistent
          this.editConfig.schedule = this.scheduleEdit.schedule;
          this.editConfig.timezone = this.scheduleEdit.timezone;
        } else {
          const data = await r.json();
          this.showToast(data.error || 'Save failed', 'error');
        }
      } catch (err) {
        this.showToast('Save failed: ' + err.message, 'error');
      }
    },

    // --- Logs ---
    async loadLogs() {
      try {
        const params = new URLSearchParams();
        if (this.logDate) params.set('date', this.logDate);
        params.set('limit', '500');
        const r = await fetch('/api/logs?' + params);
        if (r.ok) {
          const data = await r.json();
          this.logFiles = data.files || [];
          // Parse log lines into objects
          this.logLines = data.lines.map(line => this.parseLogLine(line));
        }
      } catch {}
    },
    connectSSE() {
      if (this.sseSource) { this.sseSource.close(); this.sseSource = null; }
      this.sseSource = new EventSource('/api/logs/stream');
      this.sseSource.onopen = () => { this.sseConnected = true; this._sseRetries = 0; };
      this.sseSource.onerror = () => {
        this.sseConnected = false;
        // EventSource auto-reconnects, but if it keeps failing, reconnect with backoff
        this._sseRetries = (this._sseRetries || 0) + 1;
        if (this._sseRetries >= 5) {
          this.sseSource.close();
          const delay = Math.min(30000, 2000 * this._sseRetries);
          setTimeout(() => this.connectSSE(), delay);
        }
      };
      // Listen for cleanup-complete event — handles both Cleanup tab and per-category runs
      this.sseSource.addEventListener('cleanup-complete', (e) => {
        try {
          const stats = JSON.parse(e.data);
          // Update Cleanup tab
          this.cleanupResults = stats;
          this.cleanupLastRun = new Date().toISOString();
          this.cleanupRunning = false;
          this.cleanupCancelling = false;
          // Update per-category results in Overview tab
          if (stats.categories) {
            for (const [catName, catData] of Object.entries(stats.categories)) {
              if (this.categoryRunning[catName]) {
                this.categoryResults = { ...this.categoryResults, [catName]: {
                  ...catData, dryRun: stats.dryRun, duration: stats.duration,
                }};
                const updated = { ...this.categoryRunning }; delete updated[catName]; this.categoryRunning = updated;
              }
            }
          }
          this.loadStats();
          this.loadStatus();
        } catch (err) { console.warn('SSE cleanup-complete parse error:', err); }
      });
      this.sseSource.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data.type === 'connected') return;
          this.logLines.push(data);
          // Keep max 1000 lines
          if (this.logLines.length > 1000) this.logLines.splice(0, this.logLines.length - 1000);
          // Auto-scroll only if user is near the bottom
          this.$nextTick(() => {
            const c = this.$refs.logContainer;
            if (c && (c.scrollHeight - c.scrollTop - c.clientHeight) < 100) {
              c.scrollTop = c.scrollHeight;
            }
          });
        } catch {}
      };
    },
    parseLogLine(line) {
      const m = line.match(/^\[(.+?)\]\s+\[(\w+)\]\s+(.*)$/);
      if (m) return { timestamp: m[1], level: m[2], message: m[3] };
      return { message: line };
    },
    get filteredLogs() {
      return this.logLines.filter(l => {
        if (this.logFilter !== 'All' && l.level !== this.logFilter) return false;
        if (this.logSearch && !(l.message || '').toLowerCase().includes(this.logSearch.toLowerCase())) return false;
        return true;
      });
    },

    // --- Statistics ---
    get statsHighestRun() {
      const liveRuns = (this.stats.history || []).filter(h => !h.dryRun && h.purged > 0);
      if (liveRuns.length === 0) return { purged: 0, date: '' };
      const best = liveRuns.reduce((a, b) => a.purged > b.purged ? a : b);
      return { purged: best.purged, date: new Date(best.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) };
    },
    get statsErrorRate() {
      if (!this.stats.lifetime?.totalRuns) return 0;
      return this.stats.lifetime.totalErrors / this.stats.lifetime.totalRuns;
    },
    get statsBreakdownEmpty() {
      const bd = this.getBreakdownData();
      return bd.catData.length === 0 && bd.chData.length === 0;
    },
    getBreakdownData() {
      if (this.statsView === 'allTime') {
        const catEntries = Object.entries(this.stats.categoryTotals || {}).filter(([,v]) => v > 0).sort((a,b) => b[1] - a[1]);
        const chEntries = Object.entries(this.stats.channelTotals || {}).filter(([,v]) => v > 0).sort((a,b) => b[1] - a[1]).slice(0, 10);
        return {
          catLabels: catEntries.map(e => e[0]), catData: catEntries.map(e => e[1]),
          chLabels: chEntries.map(e => '#' + e[0].split('/').pop()), chData: chEntries.map(e => e[1]),
          barColor: '#3fb950',
        };
      }
      // Last run — from lastLiveRun.categories (excludes dry-runs)
      const cats = this.stats.lastLiveRun?.categories || {};
      const catEntries = Object.entries(cats).map(([name, d]) => [name, d.purged || 0]).filter(([,v]) => v > 0).sort((a,b) => b[1] - a[1]);
      const chAll = [];
      for (const [, catData] of Object.entries(cats)) {
        for (const ch of catData.channels || []) {
          if (ch.purged > 0) chAll.push(['#' + ch.name, ch.purged]);
        }
      }
      chAll.sort((a,b) => b[1] - a[1]);
      const chTop = chAll.slice(0, 10);
      return {
        catLabels: catEntries.map(e => e[0]), catData: catEntries.map(e => e[1]),
        chLabels: chTop.map(e => e[0]), chData: chTop.map(e => e[1]),
        barColor: '#58a6ff',
      };
    },
    initStatsCharts() {
      if (!this.stats.history || this.stats.history.length === 0) return;

      // Timeline — live runs only, chronological
      const liveHistory = [...(this.stats.history || [])].filter(h => !h.dryRun).reverse();
      const tlLabels = liveHistory.map(h => new Date(h.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      const tlPurged = liveHistory.map(h => h.purged);
      const tlErrors = liveHistory.map(h => h.errors);
      const tlEl = document.getElementById('timelineChart');
      if (tlEl) {
        window._statsTimelineChart = new Chart(tlEl, {
          type: 'line',
          data: {
            labels: tlLabels,
            datasets: [
              { label: 'Deleted', data: tlPurged, borderColor: '#58a6ff', backgroundColor: 'rgba(88,166,255,0.08)', fill: true, tension: 0.3, pointRadius: 3, pointHoverRadius: 6, pointBackgroundColor: '#58a6ff' },
              { label: 'Errors', data: tlErrors, borderColor: '#f85149', fill: false, tension: 0.3, pointRadius: 2, pointHoverRadius: 5, pointBackgroundColor: '#f85149', borderWidth: 1.5 },
            ],
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: { legend: { position: 'top', align: 'end', labels: { boxWidth: 12, padding: 16, usePointStyle: true } }, tooltip: chartTooltip },
            scales: { x: { grid: { display: false }, ticks: { maxRotation: 0, autoSkipPadding: 20 } }, y: { beginAtZero: true, grid: { color: '#21262d' } } },
          },
        });
      }

      // Breakdown charts
      const bd = this.getBreakdownData();
      const catEl = document.getElementById('categoryChart');
      if (catEl) {
        window._statsCategoryChart = new Chart(catEl, {
          type: 'doughnut',
          data: {
            labels: bd.catLabels,
            datasets: [{ data: bd.catData, backgroundColor: chartPalette.slice(0, bd.catLabels.length), borderColor: '#161b22', borderWidth: 2 }],
          },
          options: {
            responsive: true, maintainAspectRatio: false, cutout: '55%',
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 10, padding: 10, usePointStyle: true } },
              tooltip: { ...chartTooltip, callbacks: { label: (ctx) => ` ${ctx.label}: ${ctx.parsed.toLocaleString()} messages` } },
            },
          },
        });
      }
      const chEl = document.getElementById('topChannelsChart');
      if (chEl) {
        window._statsChannelsChart = new Chart(chEl, {
          type: 'bar',
          data: {
            labels: bd.chLabels,
            datasets: [{ label: 'Messages deleted', data: bd.chData, backgroundColor: bd.barColor, hoverBackgroundColor: '#79c0ff', borderRadius: 3, barThickness: 22 }],
          },
          options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: chartTooltip },
            scales: {
              x: { beginAtZero: true, grid: { color: '#21262d' } },
              y: { grid: { display: false }, ticks: { font: { family: "'SF Mono', Monaco, monospace", size: 11 } } },
            },
          },
        });
      }
    },
    destroyStatsCharts() {
      if (window._statsTimelineChart) { window._statsTimelineChart.destroy(); window._statsTimelineChart = null; }
      if (window._statsCategoryChart) { window._statsCategoryChart.destroy(); window._statsCategoryChart = null; }
      if (window._statsChannelsChart) { window._statsChannelsChart.destroy(); window._statsChannelsChart = null; }
    },
    updateBreakdownCharts() {
      const bd = this.getBreakdownData();
      if (window._statsCategoryChart) {
        window._statsCategoryChart.data.labels = bd.catLabels;
        window._statsCategoryChart.data.datasets[0].data = bd.catData;
        window._statsCategoryChart.data.datasets[0].backgroundColor = chartPalette.slice(0, bd.catLabels.length);
        window._statsCategoryChart.update();
      }
      if (window._statsChannelsChart) {
        window._statsChannelsChart.data.labels = bd.chLabels;
        window._statsChannelsChart.data.datasets[0].data = bd.chData;
        window._statsChannelsChart.data.datasets[0].backgroundColor = bd.barColor;
        window._statsChannelsChart.update();
      }
    },
    updateStatsCharts() {
      // If charts don't exist yet (first data arrived while on this tab), initialize them
      if (!window._statsTimelineChart) { this.initStatsCharts(); return; }
      const liveHistory = [...(this.stats.history || [])].filter(h => !h.dryRun).reverse();
      window._statsTimelineChart.data.labels = liveHistory.map(h => new Date(h.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      window._statsTimelineChart.data.datasets[0].data = liveHistory.map(h => h.purged);
      window._statsTimelineChart.data.datasets[1].data = liveHistory.map(h => h.errors);
      window._statsTimelineChart.update();
      this.updateBreakdownCharts();
    },

    // --- Config helpers ---
    toggleCategory(name) {
      const idx = this.openCategories.indexOf(name);
      if (idx >= 0) this.openCategories.splice(idx, 1);
      else this.openCategories.push(name);
    },
    channelName(ch) {
      if (typeof ch === 'string') return ch;
      if (typeof ch === 'object' && ch !== null) return Object.keys(ch)[0];
      return '';
    },
    channelOverride(ch) {
      if (typeof ch === 'object' && ch !== null) return Object.values(ch)[0];
      return '';
    },
    setChannelOverride(catName, idx, value) {
      const cat = this.editConfig.categories[catName];
      if (!cat || !cat._channels) return;
      const ch = cat._channels[idx];
      const name = this.channelName(ch);
      if (value === '' || value === null || value === undefined) {
        // Remove override — make it a plain string
        cat._channels[idx] = name;
      } else {
        const parsed = parseInt(value, 10);
        if (isNaN(parsed)) return;
        cat._channels[idx] = { [name]: parsed };
      }
      this.configDirty = true;
    },
    setCategoryDefault(catName, value) {
      const cat = this.editConfig.categories[catName];
      if (!cat) return;
      if (value === '' || value === null || value === undefined) {
        delete cat.default;
      } else {
        const parsed = parseInt(value, 10);
        if (isNaN(parsed)) return;
        cat.default = parsed;
      }
      this.configDirty = true;
    },
    countOverrides(cat) {
      if (!cat._channels || !Array.isArray(cat._channels)) return 0;
      return cat._channels.filter(ch => typeof ch === 'object' && ch !== null).length;
    },
    channelRetentionLabel(ch, cat) {
      if (typeof ch === 'object' && ch !== null) {
        const val = Object.values(ch)[0];
        return this.retentionLabel(val) + ' (override)';
      }
      const def = cat.default ?? this.editConfig.globalDefault;
      return this.retentionLabel(def) + ' (default)';
    },
    channelRetentionClass(ch, cat) {
      if (typeof ch === 'object' && ch !== null) {
        const val = Object.values(ch)[0];
        if (val === -1) return 'bg-green-900/30 text-gh-green border border-green-800';
        return 'bg-blue-900/30 text-gh-blue border border-blue-800';
      }
      return 'bg-gh-border text-gh-muted';
    },
    channelEffectiveRetention(ch, cat) {
      if (typeof ch === 'object' && ch !== null) return Object.values(ch)[0];
      return cat.default ?? this.editConfig.globalDefault;
    },
    retentionLabel(days) {
      if (days === -1) return 'never';
      if (days === 0) return 'all';
      return days + 'd';
    },

    // --- Computed ---
    get visibleTabs() {
      return this.tabs.filter(t => t.id !== 'schedule' || this.editConfig.scheduleEnabled !== false);
    },
    get topChannels() {
      if (!this.stats.lastRun?.categories) return [];
      const all = [];
      for (const [catName, catData] of Object.entries(this.stats.lastRun.categories)) {
        for (const ch of catData.channels || []) {
          if (ch.purged > 0) all.push({ ...ch, category: catName });
        }
      }
      return all.sort((a, b) => b.purged - a.purged).slice(0, 5);
    },
    get cronOpts() {
      return { use24HourTimeFormat: this.editConfig.display?.timeFormat !== '12h' };
    },
    get nextRunDisplay() {
      try {
        const desc = cronstrue.toString(this.status.schedule || '0 2 * * *', this.cronOpts);
        const timeMatch = desc.match(/at (\d{1,2}:\d{2}(?:\s*[AP]M)?)/i);
        return timeMatch ? timeMatch[1] : desc;
      } catch { return '—'; }
    },
    get cronHuman() {
      try {
        return cronstrue.toString(this.status.schedule || '0 2 * * *', this.cronOpts) + ' (' + (this.status.timezone || 'UTC') + ')';
      } catch { return 'Invalid cron expression'; }
    },
    get scheduleHumanPreview() {
      try {
        return cronstrue.toString(this.scheduleEdit.schedule || '0 2 * * *', this.cronOpts) + ' (' + (this.scheduleEdit.timezone || 'UTC') + ')';
      } catch { return 'Invalid cron expression'; }
    },

    // --- Utilities ---
    formatDuration(ms) {
      if (!ms) return '—';
      if (ms < 1000) return ms + 'ms';
      const s = Math.round(ms / 1000);
      if (s < 60) return s + 's';
      return Math.floor(s / 60) + 'm ' + (s % 60) + 's';
    },
    formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const is12h = this.editConfig.display?.timeFormat === '12h';
      const timePart = d.toLocaleTimeString(is12h ? 'en-US' : 'en-GB', { hour: '2-digit', minute: '2-digit', hour12: is12h });
      return d.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' }) + ' ' + timePart;
    },
    showToast(msg, type = 'success') {
      this.toast = msg;
      this.toastType = type;
      clearTimeout(this.toastTimer);
      this.toastTimer = setTimeout(() => { this.toast = ''; }, 3000);
    },
  };
}
</script>
</body>
</html>
